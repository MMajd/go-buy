<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" content="text/html" http-equiv="Content-Type">
    <meta content="width=device-width, initial-scale=1.0, minimum-scaled=1.0" name="viewport">

    <title>Admin Panel | [[${pageTitle}]]</title>

    <link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}"/>
    <script type="text/javascript" th:src="@{/webjars/jquery/jquery.min.js}"></script>
    <script type="text/javascript" th:src="@{/webjars/bootstrap/js/bootstrap.min.js}"></script>
    <!--    <link rel="stylesheet" type="text/css" th:href="@{/fontawesome/all.css}" />-->
    <!--    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}" />-->
    <!--    <script type="text/javascript" th:src="@{/js/common.js}"></script>-->
</head>
<body class="container-fluid align-items-center">

<div class="d-flex flex-column align-items-center justify-content-center">
    <h1 style="mb-5" th:text="#{user-form}"></h1>
    <form id="user-form"
          enctype="multipart/form-data"
          class="form mx-5"
          th:action="${user.id == null} ? @{/users/save} : @{'/users/update/' + ${user.id}}"
          th:object="${user}"
          onsubmit="return checkEmail(this);"
          method="POST"
          style="max-width: 800px"
    >
        <input type="hidden" id="userId" name="id" th:field="*{id}">
        <div class="form-group row mb-2">
            <input class="form-control" placeholder="Enter email" type="email" th:field="*{email}" required
                   minlength="8" maxlength="128"/>
        </div>
        <div class="form-group row mb-2">
            <label th:for="firstName" class="col-3 form-label-col"></label>
            <input class="form-control" placeholder="Enter first name" type="text"
                   th:field="*{firstName}" required minlength="3" maxlength="40"/>
        </div>
        <div class="form-group row mb-2">
            <input class="form-control" placeholder="Enter last name" type="text"
                   th:field="*{lastName}" required minlength="3" maxlength="40"/>
        </div>
        <div class="form-group row mb-2">
            <input th:if="${user.id == null}" class="form-control" placeholder="Enter password" type="password"
                   th:field="*{password}" required minlength="8" maxlength="20"/>

            <input th:unless="${user.id == null}" class="form-control" placeholder="Enter password" type="password"
                   th:field="*{password}" minlength="8" maxlength="20"/>
        </div>
        <div class="form-group row mb-2">
            <label class="col-3 col-form-label">Roles</label>
            <div class="col-9">
                <th:block th:each="role : ${roles}">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox"
                               th:field="*{roles}"
                               th:name="${role.name}"
                               th:id="${role.name}"
                               th:value="${role.id}"
                        >
                        <label class="form-check-label" th:for="${role.name}">[[${role.name}]]</label>
                    </div>
                </th:block>
            </div>
            <div class="form-group row mb-2">
                <label class="col-3 col-form-label" for="enabled">Enabled</label>
                <div class="col-9">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox"
                               th:field="*{enabled}"
                               th:value="${user.enabled}"
                               id="enabled">
                        <label class="form-label-check" for="enabled">[[${user.enabled}? Enabled : Disabled]]</label>
                    </div>
                </div>
            </div>
            <div class="form-group row mb-2">
                <label class="col-3 col-form-label" for="fileImage" th:text="#{user-image}"></label>
                <div class="col-9">
                    <input type="hidden" th:field="*{photo}">
                    <div class="form-check">
                        <input type="file"
                               accept="image/png,image/jpeg,image/jpg"
                               id="fileImage"
                               name="image"
                               th:value="${user.photo}"
                               class="mr-2 mb-2"
                        >
                        <img id="thumbnail" alt="Photo Previews" th:src="@{${user.imagePath}}" class="img-fluid"
                             style="height: 200px">
                    </div>
                </div>
            </div>
            <div class="form-group row mb-2">
                <div class="col-12 d-flex justify-content-center align-items-center">
                    <input class="btn btn-primary mx-2" type="submit" value="Submit">
                    <a th:href="@{/users}" class="btn btn-danger mx-2">Cancel</a>
                </div>
            </div>
        </div>
    </form>
</div>

<script type="text/javascript">
  	const MAX_FILE_SIZE = 102400 * 10;

    function checkEmail(form) {
      const email = $("#email").val();
      const id = $("#userId").val();
      const _csrf = $("input[name='_csrf']").val();
      const url = "[[@{/api/users/check-email}]]";

      $.post(url, {id, email, _csrf}, function (res) {
          if (res) {
            form.submit();
          } else {
            alert("Email already exist");
          }
      }).fail(function (error) {
        console.log(error);
        alert("Something went wrong, please try again later");
      });

      return false;
    }

   $(document).ready(function() {
      $("#buttonCancel").on("click", function() {
          window.location = moduleURL;
      });

      $("#fileImage").change(function() {
          if(!checkFileSize(this)){
              return;
          }

          showImageThumbnail(this);
      });
    });

    function showImageThumbnail(fileInput) {
        var file = fileInput.files[0];
        var reader = new FileReader();
        reader.onload = function(e) {
            $("#thumbnail").attr("src", e.target.result);
        };

        reader.readAsDataURL(file);
    }

    function checkFileSize(fileInput){
        fileSize = fileInput.files[0].size;

        if (fileSize > MAX_FILE_SIZE) {
            fileInput.setCustomValidity("You must choose an image less than " + MAX_FILE_SIZE + " bytes!");
            fileInput.reportValidity();

            return false;
        } else {
            fileInput.setCustomValidity("");

            return true;
        }
    }


























</script>
</body>
</html>
